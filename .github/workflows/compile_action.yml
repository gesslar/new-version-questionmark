name: Build and Release Action

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ConfigureWorkflow:
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      perform_testing: ${{ steps.cfg.outputs.perform_testing }}
      perform_linting: ${{ steps.cfg.outputs.perform_linting }}
      package_manager: ${{ steps.cfg.outputs.package_manager }}
      pm_install_cmd: ${{ steps.cfg.outputs.pm_install_cmd }}

    steps:
      - name: Configure workflow
        id: cfg
        run: |+
          ### PACKAGE MANAGER #################################################
          #
          # Set the package manager to use: 'npm' or 'pnpm'
          # This will configure the appropriate setup and commands throughout
          # the workflow.

          PACKAGE_MANAGER="pnpm"
          echo "package_manager=${PACKAGE_MANAGER}" >> "$GITHUB_OUTPUT"

          # Set package manager specific commands and versions
          if [ "$PACKAGE_MANAGER" = "pnpm" ]; then
            echo "pm_install_cmd=pnpm install --frozen-lockfile" >> "$GITHUB_OUTPUT"
          else
            echo "pm_install_cmd=npm ci" >> "$GITHUB_OUTPUT"
          fi

          ### LINTING #########################################################
          #
          # If we need to perform linting, set the value to 'yes'. Any other
          # value will skip linting.

          echo "perform_linting=yes" >> "$GITHUB_OUTPUT"

          ### TESTING #########################################################
          #
          # If we need to perform testing, set the value to 'yes'. Any other
          # value will skip testing.

          echo "perform_testing=no" >> "$GITHUB_OUTPUT"

  Lint:
    needs: ConfigureWorkflow
    runs-on: ubuntu-latest

    permissions:
      contents: read

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Check out repository
        if: ${{ needs.ConfigureWorkflow.outputs.perform_linting == 'yes' }}
        uses: actions/checkout@v6

      - name: Install pnpm
        if: ${{ needs.ConfigureWorkflow.outputs.perform_linting == 'yes' && needs.ConfigureWorkflow.outputs.package_manager == 'pnpm' }}
        uses: pnpm/action-setup@v4

      - name: Using Node v${{ matrix.node-version }}
        if: ${{ needs.ConfigureWorkflow.outputs.perform_linting == 'yes' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: ${{ needs.ConfigureWorkflow.outputs.package_manager }}

      - name: Install dependencies
        if: ${{ needs.ConfigureWorkflow.outputs.perform_linting == 'yes' }}
        run: ${{ needs.ConfigureWorkflow.outputs.pm_install_cmd }}

      - name: Perform lint check
        if: ${{ needs.ConfigureWorkflow.outputs.perform_linting == 'yes' }}
        run: ${{ needs.ConfigureWorkflow.outputs.package_manager }} run lint

  Test:
    needs: ConfigureWorkflow
    runs-on: ubuntu-latest

    permissions:
      contents: read

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Check out repository
        if: ${{ needs.ConfigureWorkflow.outputs.perform_testing == 'yes' }}
        uses: actions/checkout@v6

      - name: Install pnpm
        if: ${{ needs.ConfigureWorkflow.outputs.perform_testing == 'yes' && needs.ConfigureWorkflow.outputs.package_manager == 'pnpm' }}
        uses: pnpm/action-setup@v4

      - name: Using Node v${{ matrix.node-version }}
        if: ${{ needs.ConfigureWorkflow.outputs.perform_testing == 'yes' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: ${{ needs.ConfigureWorkflow.outputs.package_manager }}

      - name: Install dependencies
        if: ${{ needs.ConfigureWorkflow.outputs.perform_testing == 'yes' }}
        run: ${{ needs.ConfigureWorkflow.outputs.pm_install_cmd }}

      - name: Definitely don't cheat on tests
        if: ${{ needs.ConfigureWorkflow.outputs.perform_testing == 'yes' }}
        run: ${{ needs.ConfigureWorkflow.outputs.package_manager }} test

  tag-and-build-on-merge:
    needs: [ConfigureWorkflow, "Lint", "Test"]
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Install pnpm
        if: ${{ needs.ConfigureWorkflow.outputs.perform_linting == 'yes' && needs.ConfigureWorkflow.outputs.package_manager == 'pnpm' }}
        uses: pnpm/action-setup@v4

      - name: Read package version
        id: version
        run: echo "version=$(jq -r '.version' 'package.json')" >> "$GITHUB_OUTPUT"

      - name: Check for existing tag
        id: check_tag
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git fetch --tags
          TAG="v${VERSION}"
          echo "tag_name=${TAG}" >> "$GITHUB_OUTPUT"
          if git tag -l "$TAG" | grep -q "^${TAG}$"; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        id: create_push_tag
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: v${{ steps.version.outputs.version }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          if [ -z "$MERGE_SHA" ]; then
            echo "Merge commit SHA is missing; exiting."
            exit 1
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" "$MERGE_SHA" -m "Version $VERSION"
          git push origin "$TAG"
          echo "Created tag $TAG at $MERGE_SHA"
          echo
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        if: steps.check_tag.outputs.tag_exists == 'false'
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: ${{ needs.ConfigureWorkflow.outputs.package_manager }}

      - name: Install NCC
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: ${{ needs.ConfigureWorkflow.outputs.package_manager }} install -g @vercel/ncc

      - name: Install dependencies
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: ${{ needs.ConfigureWorkflow.outputs.package_manager }} install

      - name: Remove old index.js
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: rm -fv action/index.js

      - name: Build
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: ${{ needs.ConfigureWorkflow.outputs.package_manager }} run build

      - name: Check for changes in
        if: steps.check_tag.outputs.tag_exists == 'false'
        id: changes_check_merge
        run: |
          lines_changed=$(git status -s | wc --lines)
          echo "has_changes=$lines_changed" >> $GITHUB_OUTPUT
          echo "Lines changed: $lines_changed"

      - name: Publish GitHub Action
        if: steps.check_tag.outputs.tag_exists == 'false' && steps.changes_check_merge.outputs.has_changes != '0'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add . ':!package-lock.json'
          git commit -m "Auto-build GitHub Action" &&
          git push origin main

      - name: Create Release
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_push_tag.outputs.tag }}
        run: >
          gh release create "$TAG"
          --title "Release $TAG"
          --notes "This is an update that has been automatically built. For the
          love of all that is holy, unholy, or morally grey, someone please take
          the keyboard away from me. I'm going to run out of repo space soon."
