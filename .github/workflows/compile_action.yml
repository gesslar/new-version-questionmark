name: Build and Release Action

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag-and-build-on-merge:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Read package version
        id: version
        run: echo "version=$(jq -r '.version' 'package.json')" >> "$GITHUB_OUTPUT"

      - name: Check for existing tag
        id: check_tag
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git fetch --tags
          TAG="v${VERSION}"
          echo "tag_name=${TAG}" >> "$GITHUB_OUTPUT"
          if git tag -l "$TAG" | grep -q "^${TAG}$"; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        id: create_push_tag
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: v${{ steps.version.outputs.version }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          if [ -z "$MERGE_SHA" ]; then
            echo "Merge commit SHA is missing; exiting."
            exit 1
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" "$MERGE_SHA" -m "Version $VERSION"
          git push origin "$TAG"
          echo "Created tag $TAG at $MERGE_SHA"
          echo
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        if: steps.check_tag.outputs.tag_exists == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install NCC
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: npm install -g @vercel/ncc

      - name: Install dependencies
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: npm install

      - name: Remove old index.js
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: rm -fv action/index.js

      - name: Build
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: npm run build

      - name: Check for changes in
        if: steps.check_tag.outputs.tag_exists == 'false'
        id: changes_check_merge
        run: |
          lines_changed=$(git status -s | wc --lines)
          echo "has_changes=$lines_changed" >> $GITHUB_OUTPUT
          echo "Lines changed: $lines_changed"

      - name: Publish GitHub Action
        if: steps.check_tag.outputs.tag_exists == 'false' && steps.changes_check_merge.outputs.has_changes != '0'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git commit -m "Auto-build GitHub Action" &&
          git push origin main

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Use the default token
        with:
          tag_name: ${{ steps.create_push_tag.outputs.tag }}
          release_name: Release ${{ steps.create_push_tag.outputs.tag }}
          body: |
            This is an update that has been automatically built. For the love
            of all that is holy, unholy, or morally grey, someone please take
            the keyboard away from me. I'm going to run out of repo space soon.
          draft: false
          prerelease: false
